<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout/default_layout}">
>
<th:block layout:fragment="content">
    <div>
        <div class="menu-list-navi">
            <select class="mt-3 ms-3" onchange="(location.href = this.value);" style="width: 180px; height: 30px">
                <option value="/menuList">전체</option>
                <option th:each="category : ${categories}"
                        th:value="|/menuList?category=${category.id}|"
                        th:text="${category.name}"
                        th:selected="${#strings.equals(param.category, category.id)}">
                </option>
            </select>
            <input type="text" id="search-input" placeholder="メニュー名で検索" oninput="filterMenus()">
            <button class="btn btn-primary" onclick="location.href='/menuCreate'">メニュー登録</button>
        </div>
        <div id="scrollable-content" class="scrollable-container">
            <div id="menu-container" class="mt-3 d-flex flex-wrap justify-content-around">
                <div th:each="menu : ${menus}" class="menu-item border text-center align-content-center"
                     th:id="${menu.id}" style="width: 20%; height: 30%;" th:onclick="|detail(${menu.id})|">
                    <div class="user-select-none">
                        <img th:src="${menu.image}" style="width: 150px; height: 150px;">
                        <div id="menu-name" class="user-select-none" th:text="${menu.name}"></div>
                        <div class="user-select-none"
                             th:text="|${#numbers.formatInteger(menu.price,1,'COMMA')} 원|"></div>
                        <div th:each="category : ${categories}">
                            <div class="user-select-none" th:text="|カテゴリー : ${category.name}|"
                                 th:if="${category.id == menu.category}"></div>
                        </div>
                        <div id="menu-stock" class="user-select-none">
                            <span th:text="|ストック : ${menu.stock}|"></span>
                            <span style="color: #7e149f" th:if="${menu.stockorder != 0}"
                                  th:text="| + ${menu.stockorder}|"></span>
                        </div>
                        <div th:each="sale : ${salesCount}" th:if="${sale.key.id == menu.id}">
                            <div th:if="${sale.key.id == menu.id}" class="user-select-none"
                                 th:text="|${salesDays}日間販売量 : ${sale.value}|"></div>
                            <div th:if="${menu.stock <= 0}" class="user-select-none"
                                 style="color: #ff363b; font-weight: bold;"
                                 th:text="在庫切れ"></div>
                            <div th:if="${menu.stock > 0}">
                                <div th:if="${menu.stock < sale.value * 0.5}" class="user-select-none"
                                     style="color: #ff363b"
                                     th:text="在庫不足"></div>
                                <div th:if="${menu.stock >= sale.value * 0.5}" class="user-select-none"
                                     style="color: #0a53be"
                                     th:text="在庫あり"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="menuModal" tabindex="-1" aria-labelledby="menuModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">メニュー詳細</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <img id="modalImage" src="" style="width: 100%; height: auto;">
                        <p id="modalPrice"></p>
                        <p id="modalCategory"></p>
                        <p id="modalStock"></p>
                        <p id="modalDescription"></p>
                    </div>
                    <div class="modal-footer">
                        <input type="number" id="order-input" placeholder="수량 입력"
                               style="display: none; margin-right: 10px;">
                        <div id="alert-container"
                             style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1050;"></div>
                        <button type="button" class="btn btn-warning" id="order-button" onclick="toggleOrderInput()">
                            発注
                        </button>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="update()">修正
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let currentMenu;

            function detail(pk) {
                currentMenu = pk;
                // AJAX를 사용하여 메뉴 상세 정보를 가져옴
                $.ajax({
                    url: '/menuDetail?id=' + pk,
                    type: 'GET',
                    success: function (data) {
                        console.log(data)
                        // 데이터가 성공적으로 로드되면 모달에 데이터를 설정
                        $('#modalTitle').text(data.menu.name);
                        $('#modalImage').attr('src', data.menu.image);
                        $('#modalPrice').text('価格 : ' + data.menu.price + ' ウォン');
                        $('#modalCategory').text('カテゴリー : ' + data.category.name);
                        if (data.menu.stockorder > 0) {
                            $('#modalStock').text('ストック : ' + data.menu.stock + ' + ' + data.menu.stockorder);
                            $('#modalStock').off('click').on('click', updateStockAndOrder);
                        } else {
                            $('#modalStock').text('ストック : ' + data.menu.stock);
                            $('#modalStock').off('click');
                        }
                        $('#modalDescription').text(data.menu.description);
                        // 모달을 표시
                        var myModal = new bootstrap.Modal(document.getElementById('menuModal'), {});
                        myModal.show();
                    },
                    error: function () {
                        alert('メニューをロードエラー');
                    }
                });
            }

            function update() {
                location.href = "/menuUpdate?id=" + currentMenu;
            }

            function filterMenus() {
                const searchInput = document.getElementById('search-input').value.toLowerCase();
                const menuItems = document.getElementsByClassName('menu-item');
                for (let i = 0; i < menuItems.length; i++) {
                    const menuItem = menuItems[i];
                    const menuName = menuItem.querySelector('#menu-name').innerText.toLowerCase();
                    if (menuName.includes(searchInput)) {
                        menuItem.style.display = '';
                    } else {
                        menuItem.style.display = 'none';
                    }
                }
            }

            function orderStock() {
                const orderInput = document.getElementById('order-input');
                const orderAmount = orderInput.value;
                if (orderAmount !== '' && !isNaN(orderAmount) && orderAmount > 0) {
                    $.ajax({
                        url: '/orderStock',
                        type: 'POST',
                        data: JSON.stringify({id: currentMenu, amount: orderAmount}),
                        contentType: 'application/json; charset=utf-8',
                        success: function (response) {
                            showBootstrapAlert('発注しました。', 'primary');
                            location.reload(); // 페이지를 새로고침하여 변경사항을 반영합니다.
                        },
                        error: function (error) {
                            showBootstrapAlert('発注中エラーが発生しました。', 'danger');
                        }
                    });
                } else {
                    showBootstrapAlert('入力値を確認してください。', 'warning');
                }
            }

            function showBootstrapAlert(message, type) {
                const alertContainer = document.getElementById('alert-container');
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible alert-show`;
                alertDiv.role = 'alert';
                alertDiv.style.width = '300px';  // 너비 설정
                alertDiv.style.fontSize = '1.25rem';  // 글자 크기 설정
                alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
                alertContainer.appendChild(alertDiv);

                // 알림을 5초 동안 표시
                setTimeout(function () {
                    alertDiv.classList.remove('alert-show');
                    alertDiv.classList.add('alert-fade');
                    setTimeout(function () {
                        alertDiv.remove();
                    }, 500); // 0.5초 후 요소 제거
                }, 3000); // 5초 후 자동으로 사라짐
            }

            function updateStockAndOrder() {
                let ok = confirm('発注したメニューを受領しましたか？')
                if (ok) {
                    $.ajax({
                        url: '/updateStockAndOrder',
                        type: 'POST',
                        data: JSON.stringify({id: currentMenu}),
                        contentType: 'application/json; charset=utf-8',
                        success: function (response) {
                            alert('在庫が追加されました。');
                            location.reload(); // 페이지를 새로고침하여 변경사항을 반영합니다.
                        },
                        error: function (error) {
                            alert('エラーが発生しました。');
                        }
                    });
                }
            }

            function toggleOrderInput() {
                const orderInput = document.getElementById('order-input');
                const orderButton = document.getElementById('order-button');
                if (orderInput.style.display === 'none') {
                    orderInput.style.display = 'block';
                    orderButton.innerText = '発注確認';
                    orderButton.setAttribute('onclick', 'orderStock()');
                }
            }

            $('#menuModal').on('hidden.bs.modal', function () {
                const orderInput = document.getElementById('order-input');
                const orderButton = document.getElementById('order-button');
                orderInput.style.display = 'none';
                orderButton.innerText = '発注';
                orderButton.setAttribute('onclick', 'toggleOrderInput()');
            });
        </script>

        <style>
            .menu-list-navi {
                display: flex;
                justify-content: space-between;
                height: 35px;
                align-items: flex-end;
            }

            .menu-list-container {
                display: flex;
                flex-direction: column;
            }

            .menu-list-bar,
            .menu-item {
                display: flex;
                justify-content: space-between; /* 항목들 사이에 공간을 균등하게 배분 */
            }

            .menu-list-bar > div,
            .menu-item > div {
                flex: 1; /* 모든 자식 div가 동등한 공간을 차지하도록 함 */
                text-align: center; /* 텍스트를 중앙 정렬 */
                padding: 10px; /* 패딩으로 간격 추가 */
            }

            .menu-list-bar {
                margin-bottom: 20px; /* 제목과 항목들 사이의 간격 */
                font-weight: bold; /* 제목의 글자를 굵게 */
            }

            .menu-item {
                border-bottom: 1px solid #ccc; /* 항목들 사이의 구분선 */
            }

            .scrollable-container {
                height: 80vh; /* 원하는 높이 설정 */
                overflow: auto;
            }

            .alert-fade {
                transition: opacity 0.5s ease-out;
                opacity: 0;
            }

            .alert-show {
                opacity: 1;
            }
        </style>
</th:block>
</html>
